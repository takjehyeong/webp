<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì—¬í–‰ìë¥¼ ìœ„í•œ ë§›ì§‘ Â· ê´€ê´‘ëª…ì†Œ</title>
  <meta name="description" content="ì—¬í–‰ìë¥¼ ìœ„í•œ ë§›ì§‘ê³¼ ê´€ê´‘ëª…ì†Œ ì¶”ì²œ, ê²€ìƒ‰, ì¦ê²¨ì°¾ê¸° ê¸°ëŠ¥ ì œê³µ" />
  <link rel="stylesheet" href="styles.css">
  <style>
    /* ì£¼ë³€ êµí†µ(ì—­/ì •ë¥˜ì¥) ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .transit {
      margin-top:14px;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--card);
      font-size:.85rem;
    }
    .transit h3 {
      margin:0 0 8px;
      font-size:.9rem;
      font-weight:700;
    }
    .transit-list {
      margin:0;
      padding:0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .transit-item {
      display:flex;
      align-items:center;
      gap:8px;
      line-height:1.3;
    }
    .transit-item .icon { font-size:1rem; }
    .transit-item .name { font-weight:600; }
    .transit-item .distance { color:var(--muted); font-size:.78rem; }
    .transit-empty { color:var(--muted); font-size:.78rem; }

    /* ì£¼ë³€ ë§›ì§‘ íŒì—… */
    .nearby-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:120}
    .nearby-backdrop.show{display:flex}
    .nearby-modal{width:min(520px,92%);background:var(--bg);border:1px solid var(--border);border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.25);overflow:hidden}
    .nearby-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border);font-weight:700}
    .nearby-close{border:1px solid var(--border);background:transparent;border-radius:10px;padding:6px 10px;cursor:pointer}
    .nearby-body{padding:14px;max-height:60vh;overflow:auto}
    .nearby-list{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:10px}
    .nearby-item{border:1px solid var(--border);border-radius:10px;padding:10px;background:var(--card);display:flex;flex-direction:column;gap:6px}
    .nearby-item .name{font-weight:700}
    .nearby-item .addr{font-size:.88rem;color:var(--muted)}
    .nearby-item .actions{display:flex;gap:8px}
    .nearby-item .btn-link{border:1px solid var(--border);background:var(--bg);border-radius:8px;padding:6px 10px;font-size:.86rem;text-decoration:none;color:inherit}
    .nearby-meta{display:flex;align-items:center;gap:8px;font-size:.72rem;}
    #nearbyLoc{padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:var(--card);color:var(--muted);max-width:170px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .nearby-reload{border:1px solid var(--border);background:var(--card);color:var(--text);padding:4px 10px;border-radius:8px;font-size:.7rem;cursor:pointer;}
    .nearby-reload:hover{background:var(--bg);}

    /* í‰ì  í‘œì‹œ */
    .nearby-rating{display:flex;align-items:center;gap:6px;font-size:.78rem;}
    .nearby-rating .rating-value{font-weight:600;color:var(--text);}
    .nearby-rating .stars{font-size:.72rem;letter-spacing:1px;color:#fbbf24;}

    /* AI ì±— ìœ„ì ¯: FAB + í”Œë¡œíŒ… ì°½ */
    .chat-fab{
      position:fixed; right:18px; bottom:18px; z-index:220;
      width:56px; height:56px; border-radius:50%;
      border:none; cursor:pointer; color:#fff;
      background:var(--primary, #2563eb);
      box-shadow:0 12px 24px rgba(0,0,0,.2);
      display:grid; place-items:center;
    }
    .chat-fab svg{width:22px;height:22px}
    .chat-widget{
      position:fixed; right:18px; bottom:86px; z-index:220;
      width:min(360px, 92%); height:480px;
      background:var(--bg); border:1px solid var(--border);
      border-radius:16px; box-shadow:0 24px 60px rgba(0,0,0,.25);
      display:none; flex-direction:column; overflow:hidden;
    }
    .chat-widget.show{ display:flex; }
    .chat-header{
      padding:10px 12px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      background:var(--card); font-weight:700;
    }
    .chat-close{ border:1px solid var(--border); background:transparent;
      border-radius:10px; padding:6px 10px; cursor:pointer; }
    .chat-messages{
      padding:12px; gap:8px; display:flex; flex-direction:column;
      overflow:auto; flex:1; background:var(--bg);
    }
    .msg{ max-width:80%; padding:8px 10px; border-radius:12px; white-space:pre-wrap; line-height:1.35; }
    .msg.bot{ align-self:flex-start; background:var(--card); color:var(--text); border-top-left-radius:4px; }
    .msg.user{ align-self:flex-end; background:var(--primary, #2563eb); color:#fff; border-top-right-radius:4px; }
    .chat-input{
      border-top:1px solid var(--border); padding:8px; display:flex; gap:8px; background:var(--bg);
    }
    .chat-input input{
      flex:1; border:1px solid var(--border); background:var(--card);
      color:var(--text); border-radius:10px; padding:8px 10px;
    }
    .chat-send{
      border:1px solid var(--border); background:var(--card);
      border-radius:10px; padding:8px 12px; cursor:pointer;
    }

    /* í´ë¦­ ê°€ëŠ¥í•œ ë¡œê³  */
    .brand .logo { cursor: pointer; }
    /* ìƒë‹´ íŒíŠ¸ ë§í’ì„  */
    .chat-hint{
      position:fixed;
      /* JSì—ì„œ FAB ì™¼ìª½ìœ¼ë¡œ ìœ„ì¹˜ì‹œí‚´ */
      /* bottom:110px; */
      /* right:84px;   */
      background:var(--card);
      border:1px solid var(--border);
      padding:8px 12px;
      border-radius:20px;
      font-size:.75rem;
      line-height:1.3;
      box-shadow:0 8px 24px rgba(0,0,0,.18);
      animation:chatHintFadeIn .35s ease;
      z-index:221;
    }
    .chat-hint:after{
      content:"";
      position:absolute;
      right:-6px;
      top:50%;
      width:12px; height:12px;
      background:var(--card);
      border:1px solid var(--border);
      border-left:none; border-bottom:none;
      transform:translateY(-50%) rotate(45deg);
      border-radius:2px;
    }
    .chat-hint.fade-out{ animation:chatHintFadeOut .5s forwards; }
    @keyframes chatHintFadeIn { from{opacity:0;transform:translateY(6px);} to{opacity:1;transform:translateY(0);} }
    @keyframes chatHintFadeOut { to{opacity:0;transform:translateY(4px);} }

    /* ì„¤ë¬¸ì¡°ì‚¬ íŒì—… */
    .survey-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.42);display:none;align-items:center;justify-content:center;
      z-index:400; /* ì˜¤íƒ€ ìˆ˜ì • ë° ìš°ì„ ìˆœìœ„ ìƒìŠ¹ */
      padding:18px;
    }
    .survey-backdrop.show{display:flex;}
    .survey-modal{width:min(420px,92%);background:var(--bg);border:1px solid var(--border);border-radius:18px;box-shadow:0 24px 60px rgba(0,0,0,.28);overflow:hidden;display:flex;flex-direction:column;}
    .survey-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700;font-size:.95rem;}
    .survey-close{background:transparent;border:1px solid var(--border);border-radius:10px;padding:4px 10px;cursor:pointer;font-size:.8rem;}
    .survey-body{padding:16px 18px;display:flex;flex-direction:column;gap:14px;}
    .survey-stars{
      display:flex;
      gap:6px;
    }
    .survey-stars button{
      background:transparent;
      border:none;
      padding:4px;
      margin:0;
      cursor:pointer;
      font-size:2rem;
      line-height:1;
      color:#ccc;
      transition:color .15s, transform .15s;
    }
    .survey-stars button:hover,
    .survey-stars button:focus-visible{
      color:#f3b41b;
      outline:none;
      transform:scale(1.05);
    }
    .survey-stars button[aria-pressed="true"]{
      color:#f3b41b;
    }
    .survey-stars button:focus-visible{
      box-shadow:0 0 0 2px var(--primary,#2563eb);
      border-radius:6px;
    }
    .survey-comment{width:100%;border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:12px;padding:10px 12px;font-size:.85rem;resize:vertical;min-height:90px;}
    .survey-actions{display:flex;flex-direction:column;gap:8px;margin-top:4px;}
    .survey-actions .row{display:flex;gap:8px;justify-content:space-between;}
    .survey-submit{flex:1;}
    .survey-hide7{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:.75rem;cursor:pointer;}
    .survey-toast{padding:12px;border:1px solid var(--border);background:var(--card);border-radius:12px;text-align:center;font-size:.9rem;font-weight:600;color:var(--primary,#2563eb);}
  </style>
  <!-- Kakao Maps SDK: ì‹¤ì œ ì•±í‚¤ë¡œ êµì²´ -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9ea6307d093424b5d332f6838987fb7d&libraries=services"></script>
</head>
<body>
  <header>
    <div class="container">
      <div class="nav">
        <div class="brand">
          <div class="logo" id="siteLogo" role="button" tabindex="0" aria-label="í™ˆìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨" title="ìƒˆë¡œê³ ì¹¨">TR</div>
          <div>ì—¬í–‰ìë¥¼ ìœ„í•œ ë§›ì§‘ Â· ê´€ê´‘ëª…ì†Œ</div>
        </div>
        <div class="tools">
          <button id="toggleTheme" class="btn" aria-label="ë‹¤í¬ ëª¨ë“œ í† ê¸€">ë‹¤í¬ ëª¨ë“œ</button>
          <button id="showFavorites" class="btn" aria-label="ì¦ê²¨ì°¾ê¸° ë³´ê¸°">ì¦ê²¨ì°¾ê¸°</button>
          <a class="btn-primary btn" href="#submit" aria-label="ì¥ì†Œ ì œì•ˆ">ì¥ì†Œ ì œì•ˆí•˜ê¸°</a>
        </div>
      </div>
      <div class="searchbar">
        <div class="search-controls">
          <div class="search-input" role="search" aria-label="ê²€ìƒ‰ì°½ ë˜í¼">
            <input id="q" type="search" placeholder="ë„ì‹œ, ì¥ì†Œëª…, ë©”ë‰´, í‚¤ì›Œë“œ ê²€ìƒ‰" aria-label="ê²€ìƒ‰" />
            <button class="search-icon" aria-hidden="true" tabindex="-1">
              <!-- ê°„ë‹¨í•œ ë‹ë³´ê¸° SVG -->
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2" fill="none"/>
              </svg>
            </button>
          </div>
          <button id="filterBtn" class="btn filter-btn" aria-expanded="false" aria-controls="filterMenu" title="í•„í„°">í•„í„°</button>
          <button id="clear" class="btn" aria-label="ì´ˆê¸°í™”">ì´ˆê¸°í™”</button>
          <!-- ë‚´ ìœ„ì¹˜ ì°¾ê¸° ë²„íŠ¼ ì¶”ê°€ -->
          <button id="btnMyLocation" class="btn" type="button">ë‚´ ì£¼ë³€ ë§›ì§‘ ì°¾ê¸°</button>
        </div>
        <!-- í•„í„° ë“œë¡­ë‹¤ìš´: ê¸°ì¡´ ì…€ë ‰íŠ¸ëŠ” ì—¬ê¸°ë¡œ ì´ë™(ì•„ì´ë”” ë™ì¼) -->
        <div id="filterMenu" class="filter-menu" hidden>
          <div class="filter-row">
            <label>ì •ë ¬</label>
            <select id="sort" class="input" aria-label="ì •ë ¬">
              <option value="popular">ì¸ê¸°ìˆœ</option>
              <option value="rating">í‰ì ìˆœ</option>
              <option value="recent">ìµœì‹ ìˆœ</option>
            </select>
          </div>
          <div class="filter-row">
            <label>ë„ì‹œ</label>
            <select id="city" class="input" aria-label="ë„ì‹œ ì„ íƒ">
              <option value="">ì „ì²´ ë„ì‹œ</option>
              <option>ë¶€ì‚°</option>
              <option>ì„œìš¸</option>
              <option>ì œì£¼</option>
            </select>
          </div>
          <div class="filter-row">
            <label>ìš”ë¦¬</label>
            <select id="cuisine" class="input" aria-label="ìš”ë¦¬ ì¢…ë¥˜">
              <option value="">ì „ì²´ ìš”ë¦¬</option>
              <option value="korean">í•œì‹</option>
              <option value="western">ì–‘ì‹</option>
              <option value="chinese">ì¤‘ì‹</option>
              <option value="japanese">ì¼ì‹</option>
              <option value="fusion">í“¨ì „/ê¸°íƒ€</option>
              <option value="other">ê¸°íƒ€</option>
            </select>
          </div>
          <div class="filter-row">
            <label>ì—°ë ¹ëŒ€</label>
            <select id="ageFilter" class="input" aria-label="ì—°ë ¹ëŒ€ ì„ íƒ">
              <option value="">ì „ì²´ ì—°ë ¹ëŒ€</option>
              <option value="10s">10ëŒ€</option>
              <option value="20s">20ëŒ€</option>
              <option value="30s">30ëŒ€</option>
              <option value="40s">40ëŒ€</option>
              <option value="50s">50ëŒ€ ì´ìƒ</option>
            </select>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;padding-top:8px">
            <button id="applyFilters" class="btn btn-primary">ì ìš©</button>
            <button id="closeFilters" class="btn">ë‹«ê¸°</button>
          </div>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ ì¹©ì„ ê²€ìƒ‰ì°½ ë°”ë¡œ ì•„ë˜ë¡œ ì´ë™ -->
        <div class="chips" role="tablist" aria-label="ì¹´í…Œê³ ë¦¬" style="margin-top:12px">
          <button class="chip active" data-filter="all" role="tab" aria-selected="true">ì „ì²´</button>
          <button class="chip" data-filter="food" role="tab">ë§›ì§‘</button>
          <button class="chip" data-filter="sight" role="tab">ê´€ê´‘ëª…ì†Œ</button>
          <button class="chip" data-filter="cafe" role="tab">ì¹´í˜</button>
          <button class="chip" data-filter="night" role="tab">ì•¼ê²½/í¬ì¸íŠ¸</button>
          <button class="chip" data-filter="budget" role="tab">ê°€ì„±ë¹„</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="results">
      <div id="grid" class="grid" aria-live="polite"></div>
      <div id="empty" class="empty" hidden>ì¡°ê±´ì— ë§ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ê²€ìƒ‰ì–´ë‚˜ í•„í„°ë¥¼ ë³€ê²½í•´ ë³´ì„¸ìš”.</div>
    </section>

    <section id="submit" style="margin-top:28px">
      <h2>ì¥ì†Œ ì œì•ˆí•˜ê¸°</h2>
      <p class="pill">ì•„ë˜ ì–‘ì‹ì„ í†µí•´ ì¥ì†Œë¥¼ ì œì•ˆí•´ë³´ì„¸ìš”</p>
      <form id="suggestForm" style="display:grid;gap:10px;grid-template-columns:repeat(2,1fr)">
        <input class="input" name="name" placeholder="ì¥ì†Œëª…" required />
        <input class="input" name="city" placeholder="ë„ì‹œ (ì˜ˆ: ë¶€ì‚°)" required />
        <input class="input" name="category" placeholder="ì¹´í…Œê³ ë¦¬ (ë§›ì§‘/ê´€ê´‘ëª…ì†Œ/ì¹´í˜ ë“±)" required />
        <input class="input" name="address" placeholder="ì£¼ì†Œ" />
        <input class="input" name="price" placeholder="ì˜ˆìƒ ê°€ê²©ëŒ€ (ì˜ˆ: 15000~30000ì›)" />
        <input class="input" name="tags" placeholder="íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)" />
        <textarea class="input" name="desc" placeholder="ì„¤ëª…" style="grid-column:1/-1" rows="4"></textarea>
        <button class="btn btn-primary" type="submit" style="grid-column:1/-1">ì œì¶œ </button>
      </form>
      <div id="suggestToast" class="pill" style="margin-top:8px"></div>
    </section>
  </main>

  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modal-header">
        <div id="modalTitle" class="title"></div>
        <button id="modalClose" class="modal-close" aria-label="ë‹«ê¸°">ë‹«ê¸°</button>
      </div>
      <div class="modal-body">
        <div id="modalContent"></div>
        <div id="modalTags" class="tags">
          <!-- íƒœê·¸ ì•ì— í•´ì‹œíƒœê·¸(#) ì¶”ê°€ -->
          <span class="tag">#í‘ë¼ì§€</span>
          <span class="tag">#ì œì£¼</span>
          <span class="tag">#ë¡œì»¬ë§›ì§‘</span>
          <span class="tag">#ìƒì„ êµ¬ì´</span>
        </div>
        <!-- ì£¼ë³€ êµí†µ ì •ë³´ ì¶œë ¥ ì˜ì—­ ì¶”ê°€ -->
        <div id="modalTransit"></div>
        <div class="map" id="modalMap"></div>
      </div>
    </div>
  </div>

  <!-- ì£¼ë³€ ë§›ì§‘ íŒì—… -->
  <div id="nearbyBackdrop" class="nearby-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="nearby-modal">
      <div class="nearby-header">
        <div id="nearbyTitle">ë‚´ ì£¼ë³€ ë§›ì§‘</div>
        <div class="nearby-meta">
          <span id="nearbyLoc" aria-label="í˜„ì¬ ìœ„ì¹˜">ìœ„ì¹˜ í™•ì¸ ëŒ€ê¸°</span>
          <button id="nearbyReload" type="button" class="nearby-reload" aria-label="ìœ„ì¹˜ ì¬ê²€ìƒ‰">ì¬ê²€ìƒ‰</button>
        </div>
        <button id="nearbyClose" class="nearby-close" aria-label="ë‹«ê¸°">ë‹«ê¸°</button>
      </div>
      <div class="nearby-body">
        <div id="nearbyStatus" class="pill">í˜„ì¬ ìœ„ì¹˜ í™•ì¸ ì¤‘...</div>
        <ul id="nearbyList" class="nearby-list"></ul>
      </div>
    </div>
  </div>

  <!-- í”Œë¡œíŒ… AI ë²„íŠ¼ -->
  <button id="aiFab" class="chat-fab" aria-controls="chatWidget" aria-expanded="false" title="ìƒë‹´ ì—´ê¸°">
    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M4 5a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v8a3 3 0 0 1-3 3H9l-4 4v-4a3 3 0 0 1-1-3V5Z" stroke="currentColor" stroke-width="1.8" fill="currentColor" />
    </svg>
  </button>

  <!-- ëŒ€í™”í˜• AI ìœ„ì ¯ -->
  <div id="chatWidget" class="chat-widget" role="dialog" aria-modal="false" aria-hidden="true" aria-label="ì‹¤ì‹œê°„ ìƒë‹´">
    <div class="chat-header">
      <span>ì‹¤ì‹œê°„ ìƒë‹´</span>
      <span id="chatStatus" class="pill" style="font-size:.75rem">ì—°ê²° ëŒ€ê¸°</span>
      <button id="chatClose" class="chat-close" aria-label="ë‹«ê¸°">X</button>
    </div>
    <div id="chatMessages" class="chat-messages" aria-live="polite">
      <div class="msg bot">ìƒë‹´ ì—°ê²°ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>
    </div>
    <form id="chatForm" class="chat-input">
      <input id="chatInput" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." aria-label="ì±„íŒ… ì…ë ¥" disabled />
      <button id="chatSend" class="chat-send" type="submit" disabled>ì „ì†¡</button>
    </form>
  </div>

  <!-- ì„¤ë¬¸ì¡°ì‚¬ íŒì—… -->
  <div id="surveyBackdrop" class="survey-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="survey-modal" role="document">
      <div class="survey-head">
        <span>ì‚¬ì´íŠ¸ ë§Œì¡±ë„ í‰ê°€</span>
        <button type="button" class="survey-close" id="surveyClose" aria-label="ë‹«ê¸°">X</button>
      </div>
      <form id="surveyForm" class="survey-body">
        <div>
          <label style="font-weight:600;display:block;margin-bottom:6px;">ë³„ì </label>
          <div class="survey-stars" id="surveyStars" role="radiogroup" aria-label="ë³„ì  ì„ íƒ(1~5)">
            <button type="button" data-val="1" aria-label="1ì " aria-pressed="false">â˜…</button>
            <button type="button" data-val="2" aria-label="2ì " aria-pressed="false">â˜…</button>
            <button type="button" data-val="3" aria-label="3ì " aria-pressed="false">â˜…</button>
            <button type="button" data-val="4" aria-label="4ì " aria-pressed="false">â˜…</button>
            <button type="button" data-val="5" aria-label="5ì " aria-pressed="false">â˜…</button>
          </div>
        </div>
        <div>
          <label for="surveyComment" style="font-weight:600;display:block;margin-bottom:6px;">ì½”ë©˜íŠ¸ (ì„ íƒ)</label>
          <textarea id="surveyComment" class="survey-comment" placeholder="ì‚¬ì´íŠ¸ ì´ìš© ì†Œê°ì´ë‚˜ ê°œì„  ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš”."></textarea>
        </div>
        <div class="survey-actions">
          <div class="row">
            <button type="submit" id="surveySubmit" class="btn btn-primary survey-submit">ì œì¶œ</button>
            <button type="button" id="surveyHide7" class="survey-hide7">7ì¼ê°„ ë³´ì§€ì•Šê¸°</button>
          </div>
        </div>
      </form>
      <div id="surveyThanks" class="survey-body" style="display:none;">
        <div class="survey-toast">ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•©ë‹ˆë‹¤</div>
        <button type="button" class="btn" id="surveyThanksClose" style="margin-top:8px;">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <footer class="container">
    <div>Â© 2025 ì—¬í–‰ìë¥¼ ìœ„í•œ ë§›ì§‘ Â· ê´€ê´‘ëª…ì†Œ. 
    </div>
  </footer>
  <script src="data.js" defer></script>
  <script src="app.js" defer></script>
  <script>
    // DOMì— ë‚¨ì•„ìˆëŠ” "ì—°ë ¹ëŒ€ ì„ í˜¸: 10ëŒ€ 23% Â· 20ëŒ€ 15% ..." í…ìŠ¤íŠ¸ì—ì„œ ìµœë‹¤ ì—°ë ¹ëŒ€ ì¶”ì¶œ
    function extractTopAgeFromDOM(card){
      const walker = document.createTreeWalker(card, NodeFilter.SHOW_TEXT, null);
      let node, foundEl = null, text = "";
      while ((node = walker.nextNode())) {
        const t = node.nodeValue.trim();
        if (!t) continue;
        if (t.includes("ì—°ë ¹ëŒ€") || t.includes("ì„ í˜¸")) { foundEl = node.parentElement; text = foundEl.textContent; break; }
      }
      if (!foundEl || !/(\d{2})ëŒ€\s*\d+%/.test(text)) return { label:"", removeEl:null };
      let top = { grp:"", val:-1 };
      const re = /(\d{2})ëŒ€\s*(\d+)%/g;
      let m; 
      while ((m = re.exec(text))) {
        const val = parseInt(m[2],10);
        if (val > top.val) top = { grp: `${m[1]}ëŒ€`, val };
      }
      return { label: top.grp || "", removeEl: foundEl };
    }

    // ì—°ë ¹ëŒ€ ìµœë‹¤ ì„ í˜¸ ë¼ë²¨ ê³„ì‚°
    function getTopAgeLabel(agePref){
      if (!agePref) return "";
      let topKey = null, topVal = -Infinity;
      for (const [k, v] of Object.entries(agePref)){
        const num = typeof v === "number" ? v : parseFloat(String(v).replace("%","")) || 0;
        if (num > topVal){ topVal = num; topKey = k; }
      }
      if (!topKey) return "";
      const map = {"10s":"10ëŒ€","20s":"20ëŒ€","30s":"30ëŒ€","40s":"40ëŒ€","50s":"50ëŒ€"};
      const n = parseInt(topKey,10);
      return Number.isFinite(n) ? `${n}ëŒ€` : (map[topKey] || "");
    }

    function upsertAgeBadge(card){
      const anyIdEl = card.querySelector("[data-id]");
      // ë°ì´í„° ê¸°ë°˜ ìš°ì„ 
      let label = "";
      if (anyIdEl && window.PLACES) {
        const id = Number(anyIdEl.dataset.id);
        const place = (window.PLACES || []).find(p => p.id === id);
        if (place) label = getTopAgeLabel(place.agePref);
      }
      // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ DOM í…ìŠ¤íŠ¸ì—ì„œ íŒŒì‹±
      if (!label) {
        const fromDom = extractTopAgeFromDOM(card);
        label = fromDom.label;
        if (fromDom.removeEl) fromDom.removeEl.remove(); // ì› ë¬¸êµ¬ ì œê±°
      }

      const target = card.querySelector(".thumb") || card;
      const exists = target.querySelector(".age-badge");

      if (!label) { if (exists) exists.remove(); return; }

      if (exists) {
        exists.textContent = `${label} ì¸ê¸°`;
      } else {
        const badge = document.createElement("span");
        badge.className = "age-badge";
        badge.textContent = `${label} ì¸ê¸°`;
        target.appendChild(badge);
      }
    }

    function applyBadges(){
      const grid = document.getElementById("grid");
      if (!grid) return;
      grid.querySelectorAll(".card").forEach(upsertAgeBadge);
    }

    window.addEventListener("load", () => {
      const grid = document.getElementById("grid");
      if (!grid) return;
      applyBadges();

      const mo = new MutationObserver(muts => {
        muts.forEach(m => {
          m.addedNodes.forEach(n => {
            if (n.nodeType === 1 && n.classList.contains("card")) upsertAgeBadge(n);
          });
        });
      });
      mo.observe(grid, { childList: true, subtree: false });
    });

    /* ì£¼ë³€ êµí†µ ë°ì´í„° ë§¤í•‘ (ì¥ì†Œëª… ê¸°ë°˜) */
    const NEARBY_TRANSIT = {
      "ê²½ë³µê¶": [
        { name: "ê²½ë³µê¶ì—­ (3í˜¸ì„ )", type: "subway", distance: "ë„ë³´ 3ë¶„" },
        { name: "ê´‘í™”ë¬¸ì—­ (5í˜¸ì„ )", type: "subway", distance: "ë„ë³´ 8ë¶„" },
        { name: "ê²½ë³µê¶ ë²„ìŠ¤ì •ë¥˜ì¥", type: "bus", distance: "ë„ë³´ 2ë¶„" }
      ],
      "ì„±ì‚°ì¼ì¶œë´‰": [
        { name: "ì„±ì‚°ì¼ì¶œë´‰ ì…êµ¬ ì •ë¥˜ì¥", type: "bus", distance: "ë„ë³´ 4ë¶„" },
        { name: "ì„±ì‚°í•­ ì •ë¥˜ì¥", type: "bus", distance: "ë„ë³´ 9ë¶„" }
      ],
      "ë¶€ì‚° ì•¼ê²½ í¬ì¸íŠ¸": [
        { name: "ë‚¨í¬ì—­ (1í˜¸ì„ )", type: "subway", distance: "ë„ë³´ 7ë¶„" },
        { name: "ìê°ˆì¹˜ì—­ (1í˜¸ì„ )", type: "subway", distance: "ë„ë³´ 10ë¶„" },
        { name: "ë‚¨í¬ë™ ì¤‘ì•™ë²„ìŠ¤ì •ë¥˜ì¥", type: "bus", distance: "ë„ë³´ 5ë¶„" }
      ],
      "ì„œìš¸ ê°ì„± ì¹´í˜ ë¡œì§€": [
        { name: "í™ëŒ€ì…êµ¬ì—­ (2Â·ê²½ì˜ì¤‘ì•™Â·ê³µí•­ì² ë„)", type: "subway", distance: "ë„ë³´ 6ë¶„" },
        { name: "ì„œêµë™ ë²„ìŠ¤ì •ë¥˜ì¥", type: "bus", distance: "ë„ë³´ 3ë¶„" }
      ]
      // í•„ìš”ì‹œ ì¶”ê°€...
    };

    function renderTransit() {
      const modalTitle = document.getElementById("modalTitle");
      const box = document.getElementById("modalTransit");
      if (!modalTitle || !box) return;
      const placeName = modalTitle.textContent.trim();
      const list = NEARBY_TRANSIT[placeName] || [];
      if (!list.length) {
        box.innerHTML = '<div class="transit"><h3>ì£¼ë³€ êµí†µ</h3><div class="transit-empty">ë“±ë¡ëœ ì£¼ë³€ ì—­/ì •ë¥˜ì¥ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>';
        return;
      }
      const html = `
        <div class="transit">
          <h3>ì£¼ë³€ êµí†µ</h3>
          <ul class="transit-list">
            ${list.map(item => {
              const icon = item.type === "subway" ? "ğŸš‡" : "ğŸšŒ";
              return `<li class="transit-item"><span class="icon">${icon}</span><span class="name">${item.name}</span><span class="distance">${item.distance}</span></li>`;
            }).join("")}
          </ul>
        </div>
      `;
      box.innerHTML = html;
    }

    // ëª¨ë‹¬ í‘œì‹œ ê°ì§€(aria-hidden ë³€ê²½)
    (function observeModal(){
      const backdrop = document.getElementById("modalBackdrop");
      if (!backdrop) return;
      const applyState = () => {
        const open = backdrop.getAttribute("aria-hidden") === "false";
        document.body.classList.toggle("modal-open", open);
        if (open) setTimeout(renderTransit, 0); // ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€
      };
      const obs = new MutationObserver(applyState);
      obs.observe(backdrop, { attributes:true, attributeFilter:["aria-hidden"] });
    })();

    // ì„ íƒì ìœ¼ë¡œ ëª¨ë‹¬ íƒ€ì´í‹€ ë³€ê²½ë§Œ ê°ì§€í•˜ì—¬ ì¬ë Œë”
    const modalTitleEl = document.getElementById("modalTitle");
    if (modalTitleEl) {
      const obsTitle = new MutationObserver(() => renderTransit());
      obsTitle.observe(modalTitleEl, { childList:true });
    }

    // Kakao Placesë¡œ ì£¼ë³€ ë§›ì§‘ ê²€ìƒ‰ í›„ íŒì—… í‘œì‹œ
    (function initNearbyPopup(){
      const btn = document.getElementById('btnMyLocation');
      const backdrop = document.getElementById('nearbyBackdrop');
      const closeBtn = document.getElementById('nearbyClose');
      const statusEl = document.getElementById('nearbyStatus');
      const listEl = document.getElementById('nearbyList');
      const locEl = document.getElementById('nearbyLoc');
      const reloadBtn = document.getElementById('nearbyReload');

      // ì—­ì§€ì˜¤ì½”ë”©: ìœ„ê²½ë„ -> "ë¶€ì‚° ë‚¨êµ¬" í˜•íƒœ
      function reverseGeocode(lat, lon, onDone){
        try{
          if (!window.kakao || !kakao.maps || !kakao.maps.services) {
            onDone(null);
            return;
          }
          const geocoder = new kakao.maps.services.Geocoder();
          geocoder.coord2RegionCode(lon, lat, (result, status) => {
            if (status !== kakao.maps.services.Status.OK || !result?.length) {
              onDone(null);
              return;
            }
            // í–‰ì •ë™(H) ìš°ì„ , ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ê²°ê³¼ ì‚¬ìš©
            const pref = result.find(r => r.region_type === 'H') || result[0];
            const sido = pref.region_1depth_name || "";
            const sigungu = pref.region_2depth_name || "";
            const text = [sido, sigungu].filter(Boolean).join(" ").trim();
            onDone(text || null);
          });
        } catch {
          onDone(null);
        }
      }

      function openPopup(){
        backdrop.classList.add('show');
        backdrop.setAttribute('aria-hidden','false');
      }
      function closePopup(){
        backdrop.classList.remove('show');
        backdrop.setAttribute('aria-hidden','true');
      }
      if (closeBtn) closeBtn.addEventListener('click', closePopup);
      if (backdrop) backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closePopup(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePopup(); });

      // ì˜ì‚¬ í‰ì  ìƒì„± (ì¥ì†Œëª… ê¸°ë°˜ í•´ì‹œ => 3.5~5.0)
      function pseudoRating(name){
        let h = 0;
        for (let i=0;i<name.length;i++){
          h = (h * 31 + name.charCodeAt(i)) >>> 0;
        }
        const frac = (h % 1000) / 1000;            // 0~0.999
        const rating = 3.5 + frac * 1.5;           // 3.5 ~ 5.0
        return Math.round(rating * 10) / 10;       // í•œ ìë¦¬ ì†Œìˆ˜
      }
      // ì ˆë°˜ ë³„(Â½) ì œê±°: ì •ìˆ˜ ê°œìˆ˜ì˜ ë³„ë§Œ í‘œì‹œ
      function makeStars(r){
        const n = Math.max(0, Math.min(5, Math.round(r))); // 0~5
        return 'â˜…'.repeat(n) + 'â˜†'.repeat(5 - n);
      }

      function renderPlaces(data){
        listEl.innerHTML = "";
        if (!data || !data.length){
          statusEl.textContent = "ì£¼ë³€ ë§›ì§‘ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }
        statusEl.textContent = `ì£¼ë³€ ë§›ì§‘ ${data.length}ê³³`;
        data.slice(0,10).forEach(place => {
          const rating = pseudoRating(place.place_name);
          const stars = makeStars(rating);
          const li = document.createElement('li');
            li.className = 'nearby-item';
            li.innerHTML = `
              <div class="name">${place.place_name}</div>
              <div class="nearby-rating" aria-label="í‰ì  ${rating}">
                <span class="rating-value">${rating}</span>
                <span class="stars" aria-hidden="true">${stars}</span>
              </div>
              <div class="addr">${place.road_address_name || place.address_name || ""}</div>
              <div class="actions">
                ${place.place_url ? `<a class="btn-link" href="${place.place_url}" target="_blank" rel="noopener">ìƒì„¸ë³´ê¸°</a>`:""}
                ${place.phone ? `<a class="btn-link" href="tel:${place.phone}">ì „í™”</a>`:""}
              </div>
            `;
          listEl.appendChild(li);
        });
      }

      function searchKakaoPlaces(lat, lon){
        if (!window.kakao || !kakao.maps || !kakao.maps.services){
          statusEl.textContent = "Kakao Mapsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
          return;
        }
        statusEl.textContent = "ì£¼ë³€ ë§›ì§‘ ê²€ìƒ‰ ì¤‘...";
        const ps = new kakao.maps.services.Places();
        ps.keywordSearch(
          'ë§›ì§‘',
          (data, status) => {
            if (status === kakao.maps.services.Status.OK) {
              renderPlaces(data);
            } else {
              statusEl.textContent = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            }
          },
          { location: new kakao.maps.LatLng(lat, lon), radius: 2000 }
        );
      }

      function getLocationAndSearch(){
        if (!('geolocation' in navigator)){
          alert('ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }
        if (locEl) locEl.textContent = 'ìœ„ì¹˜ í™•ì¸ ì¤‘...';
        statusEl.textContent = "í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...";
        listEl.innerHTML = "";
        openPopup();
        navigator.geolocation.getCurrentPosition(
          (pos)=>{
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            // ì¢Œí‘œ -> í–‰ì •êµ¬ì—­ëª… í‘œì‹œ
            reverseGeocode(lat, lon, (text) => {
              if (locEl) {
                locEl.textContent = text || `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
              }
            });
            statusEl.textContent = "ì£¼ë³€ ë§›ì§‘ ê²€ìƒ‰ ì¤‘...";
            searchKakaoPlaces(lat, lon);
          },
          (err)=>{
            statusEl.textContent = `ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${err.message}`;
            if (locEl) locEl.textContent = 'ì˜¤ë¥˜';
          },
          { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
        );
      }

      if (btn) btn.addEventListener('click', getLocationAndSearch);
      if (reloadBtn) reloadBtn.addEventListener('click', getLocationAndSearch);
    })();

    /* AI ì±— ìœ„ì ¯ */
    (function initLiveSupport(){
      const fab = document.getElementById('aiFab');
      const widget = document.getElementById('chatWidget');
      const closeBtn = document.getElementById('chatClose');
      const form = document.getElementById('chatForm');
      const input = document.getElementById('chatInput');
      const sendBtn = document.getElementById('chatSend');
      const messages = document.getElementById('chatMessages');
      const statusEl = document.getElementById('chatStatus');

      // ì„¤ì •: WebSocket ì„œë²„ ì£¼ì†Œë¥¼ ì‹¤ì œ ìƒë‹´ ì„œë²„ë¡œ êµì²´í•˜ì„¸ìš”.
      const WS_URL = 'ws://localhost:3000/support'; // ì˜ˆ: wss://your-domain.com/ws/support
      let ws = null;
      let reconnectTimer = null;
      let opening = false;

      function setStatus(text){
        if (statusEl) statusEl.textContent = text;
      }
      function setEnabled(yes){
        input.disabled = !yes;
        sendBtn.disabled = !yes;
      }
      function appendMessage(who, text){
        const row = document.createElement('div');
        row.className = 'msg ' + (who === 'user' ? 'user' : 'bot'); // bot í´ë˜ìŠ¤ë¥¼ ìƒë‹´ì‚¬ ë©”ì‹œì§€ë¡œ ì¬ì‚¬ìš©
        row.textContent = text;
        messages.appendChild(row);
        messages.scrollTop = messages.scrollHeight;
      }

      function connect(){
        if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) return;
        if (opening) return;
        opening = true;
        try{
          ws = new WebSocket(WS_URL);
        }catch(e){
          opening = false;
          setStatus('ì—°ê²° ì‹¤íŒ¨');
          setEnabled(false);
          scheduleReconnect();
          return;
        }

        setStatus('ì—°ê²° ì¤‘...');
        setEnabled(false);

        ws.onopen = () => {
          opening = false;
          setStatus('ì—°ê²°ë¨');
          setEnabled(true);
          // ì´ˆê¸° í•¸ë“œì…°ì´í¬(ì„ íƒ)
          const hello = {
            type: 'hello',
            city: (typeof state !== 'undefined' && state.city) ? state.city : '',
            ua: navigator.userAgent,
            role: 'user' // ì¶”ê°€: ì‚¬ìš©ì ì—­í•  ëª…ì‹œ
          };
          try { ws.send(JSON.stringify(hello)); } catch {}
        };

        ws.onmessage = (ev) => {
          // ì„œë²„ëŠ” {type:"message", text:"..."} í˜•íƒœë¥¼ ê¶Œì¥
          try{
            const data = JSON.parse(ev.data);
            if (data && data.type === 'message' && typeof data.text === 'string'){
              appendMessage('agent', data.text);
              return;
            }
          }catch{}
          // í…ìŠ¤íŠ¸ì¼ ê²½ìš° ê·¸ëŒ€ë¡œ í‘œì‹œ
          if (typeof ev.data === 'string'){
            appendMessage('agent', ev.data);
          }
        };

        ws.onclose = () => {
          opening = false;
          setStatus('ì—°ê²° ëŠê¹€ Â· ì¬ì—°ê²° ì‹œë„ ì¤‘');
          setEnabled(false);
          scheduleReconnect();
        };

        ws.onerror = () => {
          setStatus('ì˜¤ë¥˜ Â· ì¬ì—°ê²° ì‹œë„ ì¤‘');
        };
      }

      function scheduleReconnect(){
        if (reconnectTimer) return;
        reconnectTimer = setTimeout(()=>{
          reconnectTimer = null;
          connect();
        }, 2000);
      }

      function openChat(){
        widget.classList.add('show');
        widget.setAttribute('aria-hidden','false');
        fab.setAttribute('aria-expanded','true');
        connect();
        setTimeout(()=> input?.focus(), 0);
      }
      function closeChat(){
        widget.classList.remove('show');
        widget.setAttribute('aria-hidden','true');
        fab.setAttribute('aria-expanded','false');
        // ì—°ê²°ì€ ìœ ì§€(ìƒë‹´ ì§€ì†). í•„ìš” ì‹œ ì•„ë˜ ì£¼ì„ í•´ì œí•´ ë‹«ì„ ë•Œ ì—°ê²° ëŠê¸°
        // try { ws?.close(); } catch {}
      }

      fab?.addEventListener('click', ()=> widget.classList.contains('show') ? closeChat() : openChat());
      closeBtn?.addEventListener('click', closeChat);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && widget.classList.contains('show')) closeChat(); });

      form?.addEventListener('submit', (e)=>{
        e.preventDefault();
        const q = (input.value || '').trim();
        if (!q) return;
        if (!ws || ws.readyState !== WebSocket.OPEN){
          appendMessage('agent', 'ì•„ì§ ìƒë‹´ ì—°ê²°ì´ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          return;
        }
        appendMessage('user', q);
        input.value = '';
        try { ws.send(JSON.stringify({ type:'message', text:q })); } catch {
          appendMessage('agent', 'ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      });
    })();

    // ë¡œê³  í´ë¦­/í‚¤ë³´ë“œë¡œ ìƒˆë¡œê³ ì¹¨
    (function initLogoReload(){
      const logo = document.getElementById('siteLogo') || document.querySelector('.brand .logo');
      if (!logo) return;
      const reload = () => location.reload();
      logo.addEventListener('click', reload);
      logo.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          reload();
        }
      });
    })();

    /* ìƒë‹´ íŒíŠ¸ ë°˜ë³µ: 1) 5ì´ˆ ëŒ€ê¸° 2) "ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?" 5ì´ˆ 3) "ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!" 5ì´ˆ 4) 15ì´ˆ íœ´ì‹ ë°˜ë³µ */
    (function initChatHint(){
      const FAB_ID = 'aiFab';
      const DELAY_BEFORE_FIRST = 5000;
      const SHOW_DURATION = 5000;
      const REST_DURATION = 15000;

      let started = false;
      let currentEl = null;
      let timers = [];

      function clearTimers(){
        timers.forEach(t => clearTimeout(t));
        timers = [];
      }

      function isChatOpen(){
        return document.getElementById('chatWidget')?.classList.contains('show');
      }

      function stopAll(){
        clearTimers();
        if (currentEl?.isConnected) currentEl.remove();
        currentEl = null;
        started = false;
      }

      function positionHint(el){
        const fab = document.getElementById(FAB_ID);
        if (!fab || !el) return;
        const gap = 10;
        const fabRect = fab.getBoundingClientRect();
        el.style.visibility = 'hidden';
        el.style.top = '0px';
        el.style.left = '0px';
        const elRect = el.getBoundingClientRect();
        let top = fabRect.top + (fabRect.height - elRect.height) / 2;
        let left = fabRect.left - gap - elRect.width;
        const minPad = 8;
        top = Math.max(minPad, Math.min(top, window.innerHeight - elRect.height - minPad));
        left = Math.max(minPad, Math.min(left, window.innerWidth - elRect.width - minPad));
        el.style.top = `${top}px`;
        el.style.left = `${left}px`;
        el.style.visibility = 'visible';
      }

      function createBubble(text){
        const el = document.createElement('div');
        el.className = 'chat-hint';
        el.setAttribute('role','status');
        el.textContent = text;
        document.body.appendChild(el);
        positionHint(el);
        const onResize = () => { if (el.isConnected) positionHint(el); };
        window.addEventListener('resize', onResize, { passive:true });
        const fab = document.getElementById(FAB_ID);
        if (fab){
          fab.addEventListener('click', () => {
            if (el.isConnected) el.remove();
            window.removeEventListener('resize', onResize);
            stopAll();
          }, { once:true });
        }
        return { el, onResize };
      }

      function removeBubble(ref){
        if (!ref) return;
        const { el, onResize } = ref;
        if (el.isConnected){
          el.classList.add('fade-out');
          setTimeout(() => {
            if (el.isConnected) el.remove();
            window.removeEventListener('resize', onResize);
          }, 500);
        } else {
          window.removeEventListener('resize', onResize);
        }
        if (currentEl === el) currentEl = null;
      }

      function cycle(){
        if (!started || isChatOpen()) { stopAll(); return; }

        // Step 1: 5ì´ˆ ëŒ€ê¸° í›„ ì²« ë¬¸êµ¬
        timers.push(setTimeout(() => {
          if (isChatOpen()) { stopAll(); return; }
          const first = createBubble('ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?');
          currentEl = first.el;
          // ì²« ë¬¸êµ¬ 5ì´ˆ ë…¸ì¶œ
          timers.push(setTimeout(() => {
            removeBubble(first);
            if (isChatOpen()) { stopAll(); return; }
            // ë‘ë²ˆì§¸ ë¬¸êµ¬ ì¦‰ì‹œ í‘œì‹œ
            const second = createBubble('ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!');
            currentEl = second.el;
            // ë‘ë²ˆì§¸ 5ì´ˆ ë…¸ì¶œ
            timers.push(setTimeout(() => {
              removeBubble(second);
              if (isChatOpen()) { stopAll(); return; }
              // 15ì´ˆ íœ´ì‹ í›„ ë°˜ë³µ
              timers.push(setTimeout(() => {
                if (isChatOpen()) { stopAll(); return; }
                cycle();
              }, REST_DURATION));
            }, SHOW_DURATION));
          }, SHOW_DURATION));
        }, DELAY_BEFORE_FIRST));
      }

      function start(){
        if (started) return;
        started = true;
        cycle();
      }

      ['scroll','mousemove','keydown','touchstart'].forEach(ev =>
        window.addEventListener(ev, start, { passive:true, once:true })
      );
    })();

    /* === ì„¤ë¬¸ì¡°ì‚¬ íŒì—… ì´ˆê¸°í™” === */
    (function initSiteSurvey(){
      const DELAY_MS = 20000; // 20ì´ˆë¡œ ë³€ê²½
      const LS_KEY_HIDE = 'surveyHideUntil';
      const LS_KEY_SUBMITTED = 'surveySubmitted';
      const backdrop = document.getElementById('surveyBackdrop');
      const form = document.getElementById('surveyForm');
      const closeBtn = document.getElementById('surveyClose');
      const thanksView = document.getElementById('surveyThanks');
      const thanksClose = document.getElementById('surveyThanksClose');
      const starsWrap = document.getElementById('surveyStars');
      const hide7Btn = document.getElementById('surveyHide7');
      let currentRating = 0;
      if (!backdrop) return;

      function shouldSuppress(){
        const hideUntil = parseInt(localStorage.getItem(LS_KEY_HIDE)||'0',10);
        if (hideUntil && Date.now() < hideUntil) return true;
        if (localStorage.getItem(LS_KEY_SUBMITTED)==='1') return true;
        return false;
      }

      function open(){
        backdrop.classList.add('show');
        backdrop.setAttribute('aria-hidden','false');
        // í¬ì»¤ìŠ¤ ì²« ë³„
        const firstStar = starsWrap?.querySelector('button');
        firstStar && firstStar.focus();
      }
      function close(){
        backdrop.classList.remove('show');
        backdrop.setAttribute('aria-hidden','true');
      }
      function setRating(val){
        currentRating = val;
        starsWrap.querySelectorAll('button').forEach(btn=>{
          const v = Number(btn.dataset.val);
          btn.setAttribute('aria-pressed', v <= val ? 'true':'false');
          btn.style.color = (v <= val) ? '#f3b41b' : '#ccc';
        });
      }

      // ë³„ ì¸í„°ë™ì…˜
      starsWrap?.addEventListener('click', e=>{
        const btn = e.target.closest('button[data-val]');
        if (!btn) return;
        setRating(Number(btn.dataset.val));
      });
      starsWrap?.addEventListener('mouseover', e=>{
        const btn = e.target.closest('button[data-val]');
        if (!btn) return;
        const hoverVal = Number(btn.dataset.val);
        starsWrap.querySelectorAll('button').forEach(b=>{
          const v = Number(b.dataset.val);
          b.style.color = v <= hoverVal ? '#f3b41b':'#ccc';
        });
      });
      starsWrap?.addEventListener('mouseleave', ()=>{
        starsWrap.querySelectorAll('button').forEach(b=>{
          const v = Number(b.dataset.val);
          const selected = v <= currentRating;
          b.style.color = selected ? '#f3b41b':'#ccc';
        });
      });

      // ì œì¶œ
      form?.addEventListener('submit', e=>{
        e.preventDefault();
        if (currentRating === 0){
          alert('ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        const comment = (document.getElementById('surveyComment')?.value||'').trim();
        // ì—¬ê¸°ì„œ ì„œë²„ë¡œ ì „ì†¡ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥ (fetch ë“±)
        localStorage.setItem(LS_KEY_SUBMITTED,'1');
        form.style.display='none';
        thanksView.style.display='flex';
      });

      // 7ì¼ ìˆ¨ê¹€
      hide7Btn?.addEventListener('click', ()=>{
        const sevenDays = 7*24*60*60*1000;
        localStorage.setItem(LS_KEY_HIDE, String(Date.now()+sevenDays));
        close();
      });

      // ë‹«ê¸°
      closeBtn?.addEventListener('click', close);
      thanksClose?.addEventListener('click', close);
      backdrop.addEventListener('click', e=>{
        if (e.target === backdrop) close();
      });
      document.addEventListener('keydown', e=>{
        if (e.key === 'Escape' && backdrop.classList.contains('show')) close();
      });

      // ì§€ì—° í‘œì‹œ
      if (!shouldSuppress()){
        setTimeout(()=>{
          if (!shouldSuppress()) open();
        }, DELAY_MS);
      }
    })();
  </script>
</body>
</html>